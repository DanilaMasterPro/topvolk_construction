import { casesData, renderCaseCard, renderModalCaseCard } from './casesData.js';
import { initNeuralBackground } from './neuralBackground.js';
import { pricingData, renderPricingCard } from './pricingData.js';

document.addEventListener('DOMContentLoaded', () => {
    // Initialize neural background
    initNeuralBackground();

    // Render cases
    const casesContainer = document.querySelector('.cases-slider .swiper-wrapper');
    casesContainer.innerHTML = casesData.map(caseData => renderCaseCard(caseData)).join('');

    // Initialize cases slider
    const casesSwiper = new Swiper('.cases-slider .swiper', {
        slidesPerView: 1,
        spaceBetween: 30,
        pagination: {
            el: '.cases-slider .swiper-pagination',
            clickable: true,
        },

        autoplay: {
            delay: 5000, // 5 —Å–µ–∫—É–Ω–¥
            disableOnInteraction: true // –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        },

        breakpoints: {
            // >= 768px
            768: {
                slidesPerView: 2,
            },
            // >= 1024px
            1024: {
                slidesPerView: 2,
            }
        }
    });

    // Initialize pricing cards
    const pricingContainer = document.querySelector('.pricing-grid');
    pricingContainer.innerHTML = pricingData.map(pricing => renderPricingCard(pricing)).join('');
});

function initializeSlider(slider) {
    const slides = slider.querySelectorAll('img');
    const loader = slider.closest('.case-gallery').querySelector('.gallery-loader');
    
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    Promise.all([...slides].map(img => {
        return new Promise((resolve) => {
            if (img.complete) {
                resolve();
            } else {
                img.onload = resolve;
            }
        });
    })).then(() => {
        loader.classList.add('hidden');
    });

    const sliderNav = slider.closest('.case-gallery').querySelector('.slider-nav');
    const prevBtn = slider.closest('.case-gallery').querySelector('.slider-arrow.prev');
    const nextBtn = slider.closest('.case-gallery').querySelector('.slider-arrow.next');
    
    let currentSlide = 0;
    
    // Create dots
    slides.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.classList.add('slider-dot');
        if (index === 0) dot.classList.add('active');
        dot.addEventListener('click', () => goToSlide(index));
        sliderNav.appendChild(dot);
    });
    
    const dots = sliderNav.querySelectorAll('.slider-dot');
    
    function updateDots() {
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === currentSlide);
        });
    }
    
    function goToSlide(index) {
        currentSlide = index;
        slider.style.transform = `translateX(-${index * 100}%)`;
        updateDots();
    }
    
    function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        goToSlide(currentSlide);
    }
    
    function prevSlide() {
        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
        goToSlide(currentSlide);
    }
    
    prevBtn.addEventListener('click', prevSlide);
    nextBtn.addEventListener('click', nextSlide);
    
    // Optional: Auto-advance slides
    setInterval(nextSlide, 5000);
}

// Modal handling
const modal = document.getElementById('contactModal');
const successModal = document.getElementById('successModal');
const span = document.querySelector('.close-modal');
const form = document.getElementById('contactForm');
const closeButtons = document.querySelectorAll('.close-modal');
const successBtn = document.querySelector('.success-btn');

document.addEventListener('click', (e) => {
    if (e.target.classList.contains('contact-btn')) {
        modal.style.display = 'block';
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É
span.addEventListener('click', () => {
    modal.style.display = 'none';
    document.body.style.overflow = ''; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
window.addEventListener('click', (e) => {
    if (e.target === modal || e.target === successModal) {
        modal.style.display = 'none';
        successModal.style.display = 'none';
        document.body.style.overflow = ''; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
    }
});

// –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('name').value;
    const contact = document.getElementById('contact').value;
    
    const BOT_TOKEN = '7808652944:AAHDqPPqu2_IbKpFg02rBjWwtDJN_aDomjs'; // Replace with your bot token
    const CHAT_ID = '612414314'; // Replace with your chat ID
    
    const message = `
üî• –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞!

üë§ –ò–º—è: ${name}
üì± –ö–æ–Ω—Ç–∞–∫—Ç: ${contact}
    `;
    
    try {
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: CHAT_ID,
                text: message,
                parse_mode: 'HTML'
            })
        });

        if (response.ok) {
            form.reset();
            modal.style.display = 'none';
            successModal.style.display = 'block';
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        }
    } catch (error) {
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è success –º–æ–¥–∞–ª–∫–∏
closeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        modal.style.display = 'none';
        successModal.style.display = 'none';
        document.body.style.overflow = ''; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
    });
});

// –ò–∑–º–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–ª–∏—á–Ω–æ"
successBtn.addEventListener('click', () => {
    successModal.style.display = 'none';
    modal.style.display = 'none';
    document.body.style.overflow = '';
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –æ—Ç–∑—ã–≤–æ–≤
const testimonialsSwiper = new Swiper('.testimonials-slider .swiper', {
    slidesPerView: 'auto',
    spaceBetween: 30,
    centeredSlides: true,
    loop: false,
    slidesPerView: 1.3,
    pagination: {
            el: '.testimonials-slider .swiper-pagination',
            clickable: true,
    },
    breakpoints: {
        768: {
            centeredSlides: false,
            slidesPerView: 3,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
        },
        1024: {
            centeredSlides: false,
            slidesPerView: 4,
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeButton = imageModal.querySelector('.close-button');
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤
    document.querySelectorAll('.testimonial-image').forEach(img => {
        img.addEventListener('click', function() {
            modalImage.src = this.src;
            imageModal.style.display = 'block';
        });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    imageModal.addEventListener('click', function() {
        this.style.display = 'none';
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
    closeButton.addEventListener('click', function(e) {
        e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        imageModal.style.display = 'none';
    });
});

// –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–µ–π—Å–æ–≤
const caseModal = document.getElementById('caseModal');
const caseModalContent = document.getElementById('caseModalContent');
const closeCaseModal = document.querySelector('.close-case-modal');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å"
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('view-case-btn')) {
        const caseId = e.target.dataset.caseId;
        const caseData = casesData.find(c => c.id === caseId);
        if (caseData) {
            caseModalContent.innerHTML = renderModalCaseCard(caseData);
            caseModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const modalSlider = caseModalContent.querySelector('.slider');
            if (modalSlider) {
                initializeSlider(modalSlider);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–•–æ—á—É —Ç–∞–∫–∂–µ" –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const modalContactBtn = caseModalContent.querySelector('.contact-btn');
            if (modalContactBtn) {
                modalContactBtn.addEventListener('click', () => {
                    caseModal.style.display = 'none'; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–µ–π—Å–∞
                    modal.style.display = 'block'; // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π —Ñ–æ—Ä–º—ã
                    document.body.style.overflow = 'hidden'; // –û—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                });
            }
        }
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
closeCaseModal.addEventListener('click', () => {
    caseModal.style.display = 'none';
    document.body.style.overflow = ''; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
caseModal.addEventListener('click', (e) => {
    if (e.target === caseModal) {
        caseModal.style.display = 'none';
        document.body.style.overflow = '';
    }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
caseModalContent.addEventListener('click', (e) => {
    e.stopPropagation();
});